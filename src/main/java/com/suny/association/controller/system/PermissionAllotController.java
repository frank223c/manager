package com.suny.association.controller.system;

import com.suny.association.annotation.SystemControllerLog;
import com.suny.association.controller.BaseController;
import com.suny.association.entity.dto.ResultDTO;
import com.suny.association.enums.ResponseCodeEnum;
import com.suny.association.entity.po.Permission;
import com.suny.association.entity.po.PermissionAllot;
import com.suny.association.entity.po.Roles;
import com.suny.association.service.interfaces.system.IPermissionAllotService;
import com.suny.association.service.interfaces.system.IPermissionService;
import com.suny.association.service.interfaces.IRolesService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.ModelAndView;

import java.util.ArrayList;
import java.util.List;

/**
 * Comments:   权限的具体分配，可用对角色进行分配指定权限
 * @author :   孙建荣
 * Create Date: 2017/05/02 13:02
 */
@RequestMapping("/system/permission/allot")
@Controller
public class PermissionAllotController extends BaseController {

    private final IRolesService rolesService;

    private final IPermissionAllotService permissionAllotService;

    private final IPermissionService permissionService;

    @Autowired
    public PermissionAllotController(IRolesService rolesService, IPermissionAllotService permissionAllotService, IPermissionService permissionService) {
        this.rolesService = rolesService;
        this.permissionAllotService = permissionAllotService;
        this.permissionService = permissionService;
    }


    @SystemControllerLog(description = "【修改权限】删除权限后增加权限")
    @RequestMapping(value = "/update.action", method = RequestMethod.POST)
    @ResponseBody
    public ResultDTO update(@RequestParam(value = "permissionArray[]") Integer[] permissionArray, Integer roleId) {

        if (rolesService.selectById(roleId) != null) {
            //  在修改权限之前先把角色所有的权限先清除
            if (permissionAllotService.queryByRoleId(roleId).size() > 0) {
                permissionAllotService.deleteById(roleId);
            }
            // 假如数组里面只有9999的话说明删除所有权限
            if (permissionArray[0] == 9999) {
                return ResultDTO.successResult(ResponseCodeEnum.UPDATE_SUCCESS);
            }
            // 实例化一个【权限角色中间表】实体对象
            PermissionAllot pa = new PermissionAllot();
            //  实例化一个LIst来装权限的集合
            List<Permission> perList = new ArrayList<>();
            //  实例化一个角色
            Roles r = new Roles();
            //   给角色实体设置角色id
            r.setRoleId(roleId);
            //    给【权限角色中间表】实体对象添加角色属性
            pa.setRoleId(r);
            for (Integer aPermissionArray : permissionArray) {
                //   循环实例化一个权限实体，然后填充数据，最后添加到权限lIst里面去
                Permission per = new Permission();
                per.setpermissionId(aPermissionArray);
                perList.add(per);
            }
            // 把权限集合设置到【权限角色中间表】实体对象中
            pa.setPermissionArrayList(perList);
            permissionAllotService.insert(pa);
            return ResultDTO.successResult(ResponseCodeEnum.UPDATE_SUCCESS);

        }
        return ResultDTO.failureResult(ResponseCodeEnum.SELECT_FAILURE);
    }

    @SystemControllerLog(description = "指定角色权限分配")
    @RequestMapping(value = "/update.html/{roleId}", method = RequestMethod.GET)
    public ModelAndView update(@PathVariable("roleId") int roleId, ModelAndView modelAndView) {
        //  查询一个角色对应的权限
        List<PermissionAllot> permissionList = permissionAllotService.queryByRoleId(roleId);
        //    查询数据库所有的权限
        List<Permission> permissions = permissionService.selectAll();
        modelAndView.addObject("permissionList", permissionList);
        modelAndView.addObject("permissions", permissions);
        modelAndView.setViewName("system/permission/allot/rolePermissionAllot");
        return modelAndView;
    }

    @SystemControllerLog(description = "查看权限分配页面")
    @RequestMapping(value = "/index.html", method = RequestMethod.GET)
    public ModelAndView index(ModelAndView modelAndView) {
        List<Roles> roleList = rolesService.selectAll();
        List<PermissionAllot> permissionAllotList = permissionAllotService.selectAll();
        modelAndView.addObject("roleList", roleList);
        modelAndView.addObject("permissionAllotList", permissionAllotList);
        modelAndView.setViewName("system/permission/allot/permissionAllot");
        return modelAndView;
    }

}
